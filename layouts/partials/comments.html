<div id="tw-comment"></div>

<!-- ✅ 工具函数区 -->
<script data-no-instant>
  window.getStoredTheme = function () {
    return localStorage.getItem("pref-theme") === "light"
      ? "{{ .Site.Params.giscus.lightTheme }}"
      : "{{ .Site.Params.giscus.darkTheme }}";
  };

  window.setGiscusTheme = function () {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) {
      console.warn("[Giscus] iframe not found when trying to set theme");
      return;
    }

    const theme = window.getStoredTheme();
    const message = {
      giscus: { setConfig: { theme } }
    };

    if (iframe.contentWindow) {
      iframe.contentWindow.postMessage(message, "https://giscus.app");
    } else {
      // Fallback retry
      setTimeout(() => {
        iframe.contentWindow?.postMessage(message, "https://giscus.app");
      }, 100);
    }
  };

  window.initGiscus = function () {
    const giscusAttributes = {
      "src": "https://giscus.app/client.js",
      "data-repo": "{{ .Site.Params.giscus.repo }}",
      "data-repo-id": "{{ .Site.Params.giscus.repoId }}",
      "data-category": "{{ .Site.Params.giscus.category }}",
      "data-category-id": "{{ .Site.Params.giscus.categoryId }}",
      "data-mapping": "{{ .Site.Params.giscus.mapping }}",
      "data-strict": "{{ .Site.Params.giscus.strict }}",
      "data-reactions-enabled": "{{ .Site.Params.giscus.reactionsEnabled }}",
      "data-emit-metadata": "{{ .Site.Params.giscus.emitMetadata }}",
      "data-input-position": "{{ .Site.Params.giscus.inputPosition }}",
      "data-theme": window.getStoredTheme(),
      "data-lang": "{{ .Site.Params.giscus.lang }}",
      "data-loading": "lazy",
      "crossorigin": "anonymous"
    };

    const giscusScript = document.createElement("script");
    Object.entries(giscusAttributes).forEach(([key, value]) => {
      giscusScript.setAttribute(key, value);
    });

    const mountPoint = document.getElementById("tw-comment");
    if (mountPoint) {
      mountPoint.innerHTML = "";
      mountPoint.appendChild(giscusScript);
    }

    // ✅ 仅绑定一次 toggle 切换事件
    if (!window.__giscus_theme_toggle_bound__) {
      const bindToggleEvents = () => {
        const toggle = document.querySelector("#theme-toggle");
        if (toggle) toggle.addEventListener("click", window.setGiscusTheme);

        const toggleFloat = document.querySelector("#theme-toggle-float");
        if (toggleFloat) toggleFloat.addEventListener("click", window.setGiscusTheme);
      };
      bindToggleEvents();
      window.__giscus_theme_toggle_bound__ = true;
    }
  };
</script>

<!-- ✅ 初始化逻辑（首次和 PJAX） -->
<script>
  const triggerGiscusInit = () => {
    if (typeof window.initGiscus === 'function') {
      window.initGiscus();
    }
  };

  const triggerGiscusThemeUpdate = () => {
    const waitAndSetTheme = () => {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe?.contentWindow) {
        window.setGiscusTheme();
      } else {
        setTimeout(waitAndSetTheme, 100); // Retry until iframe is ready
      }
    };
    waitAndSetTheme();
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      triggerGiscusInit();
      triggerGiscusThemeUpdate();
    });
  } else {
    triggerGiscusInit();
    triggerGiscusThemeUpdate();
  }

  if (window.InstantClick) {
    InstantClick.on('change', () => {
      triggerGiscusInit();
      triggerGiscusThemeUpdate();
    });
  }
</script>
