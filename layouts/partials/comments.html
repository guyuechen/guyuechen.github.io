<!-- ✅ Giscus 纯逻辑挂载，不再插入 DOM 容器 -->
<script data-no-instant>
  window.getStoredTheme = function () {
    return localStorage.getItem("pref-theme") === "light"
      ? "{{ .Site.Params.giscus.lightTheme }}"
      : "{{ .Site.Params.giscus.darkTheme }}";
  };

  window.setGiscusTheme = function () {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow?.postMessage({
      giscus: { setConfig: { theme: window.getStoredTheme() } }
    }, "https://giscus.app");
  };

  window.initGiscus = function () {
    const mount = document.getElementById("tw-comment");
    if (!mount || mount.dataset.giscusEnable !== "true") return;

    const script = document.createElement("script");
    const attrs = {
      src: "https://giscus.app/client.js",
      "data-repo": "{{ .Site.Params.giscus.repo }}",
      "data-repo-id": "{{ .Site.Params.giscus.repoId }}",
      "data-category": "{{ .Site.Params.giscus.category }}",
      "data-category-id": "{{ .Site.Params.giscus.categoryId }}",
      "data-mapping": "{{ .Site.Params.giscus.mapping }}",
      "data-strict": "{{ .Site.Params.giscus.strict }}",
      "data-reactions-enabled": "{{ .Site.Params.giscus.reactionsEnabled }}",
      "data-emit-metadata": "{{ .Site.Params.giscus.emitMetadata }}",
      "data-input-position": "{{ .Site.Params.giscus.inputPosition }}",
      "data-theme": window.getStoredTheme(),
      "data-lang": "{{ .Site.Params.giscus.lang }}",
      "data-loading": "lazy",
      crossorigin: "anonymous",
      async: "true"
    };

    Object.entries(attrs).forEach(([k, v]) => script.setAttribute(k, v));
    mount.innerHTML = "";
    mount.appendChild(script);

    if (!window.__giscusThemeBound__) {
      const bind = (el) => el && el.addEventListener("click", window.setGiscusTheme);
      bind(document.getElementById("theme-toggle"));
      bind(document.getElementById("theme-toggle-float"));
      window.__giscusThemeBound__ = true;
    }
  };
</script>
